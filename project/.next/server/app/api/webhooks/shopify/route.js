"use strict";(()=>{var e={};e.id=9401,e.ids=[9401],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},57441:e=>{e.exports=require("sharp")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},56466:(e,o,r)=>{r.r(o),r.d(o,{originalPathname:()=>$,patchFetch:()=>k,requestAsyncStorage:()=>b,routeModule:()=>w,serverHooks:()=>v,staticGenerationAsyncStorage:()=>S});var t={};r.r(t),r.d(t,{POST:()=>x});var s=r(49303),i=r(88716),a=r(60670),n=r(87070),p=r(84770),l=r.n(p),c=r(65655),d=r(94670),u=r(20471),h=r(55315),m=r.n(h),f=r(92048),y=r.n(f);async function g(e){try{let o=await fetch(e);if(!o.ok)throw Error(`Failed to fetch image: ${o.statusText}`);return Buffer.from(await o.arrayBuffer())}catch(e){return console.error("Failed to download image:",e),null}}async function x(e){try{let o=await e.text(),t=e.headers.get("x-shopify-topic")||"",s=e.headers.get("x-shopify-hmac-sha256")||"",i=process.env.SHOPIFY_WEBHOOK_SECRET||"dummy_secret_for_dev";if(l().createHmac("sha256",i).update(o,"utf8").digest("base64")!==s)return console.error("Invalid Webhook HMAC"),n.NextResponse.json({error:"Invalid HMAC"},{status:401});let a=JSON.parse(o);console.log(`[Shopify Webhook] Received topic: ${t}`);let p=a.email||a.customer?.email,h=a.customer?`${a.customer.first_name} ${a.customer.last_name}`:"Guest",f=!1;for(let e of a.line_items){let o=e.properties||[],t={};o.forEach(e=>{t[e.name.toLowerCase()]=e.value});let s=t["pet photo"]||t.upload||t.photo||null,i=t.breed||t["pet breed"]||"",n=t.name||t["pet name"]||t["dog name"]||"",l=t.special||t["what makes them special"]||t.details||t.notes||"",x=["pet photo","upload","photo","breed","pet breed","name","pet name","dog name","special","what makes them special","details","notes"],w=Object.entries(t).filter(([e])=>!x.includes(e)).map(([e,o])=>`${e}: ${o}`).join(", "),b=[l?`Special: ${l}`:"",n?`Name: ${n}`:"",w?`Other: ${w}`:"",`[Shopify ID: ${a.id}]`].filter(Boolean).join(". ");if(s){f=!0,console.log(`[Shopify] Found printable item: ${e.name}`);let o=`shopify-${a.id}-${Date.now()}.jpg`,t=m().join(process.cwd(),"public","uploads","pets");y().existsSync(t)||y().mkdirSync(t,{recursive:!0}),console.log(`[Shopify] Downloading pet photo from ${s}...`);let n=await g(s),l="";if(n){let e=`uploads/pets/${o}`;try{let{uploadFile:o,getPublicUrl:t}=await Promise.resolve().then(r.bind(r,2390));await o(e,n),l=t(e),console.log(`[Shopify] Uploaded to storage: ${l}`)}catch(e){console.error("Failed to upload to storage:",e);continue}}else{console.error("Could not download image, skipping generation for this item.");continue}let x=(0,c.i)(),{data:w,error:S}=await x.from("orders").insert({customer_name:h,customer_email:p,product_type:e.name||"Shopify Order",pet_image_url:l,status:"pending",pet_breed:i||null,pet_details:b}).select().single();if(S){console.error("Failed to create order in DB:",S);continue}console.log(`[Shopify] Order created: ${w.id}`),(0,u.l)(p,h,w.id,"ordered").catch(e=>console.error(e)),(0,d.yU)(w.id,l,"royalty",i,b,!1).catch(e=>{console.error(`[Shopify] Generation failed for order ${w.id}:`,e)})}}return f||console.log("[Shopify] No item with 'Pet Photo' found in this order."),n.NextResponse.json({success:!0})}catch(e){return console.error("Webhook processing failed:",e),n.NextResponse.json({error:e.message||"Internal Server Error"},{status:500})}}let w=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/webhooks/shopify/route",pathname:"/api/webhooks/shopify",filename:"route",bundlePath:"app/api/webhooks/shopify/route"},resolvedPagePath:"/Users/taylorstrong/Redemption23-1/project/src/app/api/webhooks/shopify/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:b,staticGenerationAsyncStorage:S,serverHooks:v}=w,$="/api/webhooks/shopify/route";function k(){return(0,a.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:S})}}};var o=require("../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[9276,5972,9498,2723,1258,4670],()=>r(56466));module.exports=t})();