"use strict";exports.id=4670,exports.ids=[4670],exports.modules={94670:(e,t,r)=>{r.d(t,{$y:()=>y,Vc:()=>h,h3:()=>b,yU:()=>w});var o=r(65655),a=r(92048),n=r.n(a),i=r(55315),l=r.n(i),s=r(11258),c=r(20471),p=r(2390),u=r(57441),d=r.n(u);let g="models/nano-banana-pro-preview";async function m(e){let t=d()(e),r=await t.metadata();return r.width&&r.width<3e3?t.resize(3e3,null,{kernel:"lanczos3",fit:"inside",withoutEnlargement:!1}).toBuffer():e}function f(e,t=5){let r={royalty:"royalty",spaday:"spaday",minimalist:"minimalist",valentines:"valentines",bonus:"valentines"}[e.toLowerCase()]||"royalty";e.includes("bonus")&&(r="valentines");let o=l().join(process.cwd(),"public","templates",r);if(!n().existsSync(o))return console.warn(`Theme directory not found: ${r}`),"royalty"!==e?f("royalty",t):[];try{let e=n().readdirSync(o);return e.sort(),e.filter(e=>/\.(jpg|jpeg|png|webp)$/i.test(e)).slice(0,t).map(e=>l().join(o,e))}catch(e){return console.error(`Error reading theme directory ${r}:`,e),[]}}async function h(e,t,r){try{let o=new s.$D(process.env.GOOGLE_AI_API_KEY).getGenerativeModel({model:g}),a=(e=>{let t=l().extname(e).toLowerCase();return".png"===t?"image/png":".webp"===t?"image/webp":".avif"===t?"image/avif":"image/jpeg"})(e);console.log(`[Nano] Swapping: Template (${a}) + Pet Buffer`);let i=n().readFileSync(e).toString("base64"),c=t.toString("base64"),p=await o.generateContent([r||"Replace the main subject (animal) in the first image with the customer's pet in the second image. Maintain the exact style, clothing, and composition of the first image. High quality.",{inlineData:{data:c,mimeType:"image/jpeg"}},{inlineData:{data:i,mimeType:a}}]),u=p.response.candidates?.[0]?.content?.parts,d=u?.find(e=>e.inlineData);if(!(d&&d.inlineData?.data))return console.error("Nano Banana returned no image part."),null;{let e=Buffer.from(d.inlineData.data,"base64");try{e=await m(e)}catch(e){console.error("Upscaling failed, using original:",e)}return e}}catch(e){return console.error("Nano Swap failed:",e),null}}async function y(e,t,r,o){try{let a;if("string"==typeof e){if(n().existsSync(e))a=n().readFileSync(e);else{if(!e.startsWith("http"))return console.error(`Portrait file not found: ${e}`),null;console.log(`[Mockup] Fetching remote portrait: ${e}`);let t=await fetch(e);if(!t.ok)return console.error(`Failed to download remote portrait: ${e}`),null;a=Buffer.from(await t.arrayBuffer())}}else a=e;console.log(`[Mockup] Generating for ${t}...`);let i=null,c=null,p="image/jpeg";if(o){if(o.startsWith("http")){console.log(`[Mockup] Fetching remote template: ${o}`);let e=await fetch(o);if(!e.ok)return console.error("Failed to download remote template"),null;c=Buffer.from(await e.arrayBuffer()),o.toLowerCase().endsWith(".png")&&(p="image/png"),o.toLowerCase().endsWith(".webp")&&(p="image/webp")}else if(n().existsSync(o)){c=n().readFileSync(o);let e=l().extname(o).toLowerCase();".png"===e&&(p="image/png"),".webp"===e&&(p="image/webp")}}if(!c){let e=t.toLowerCase().replace(/[^a-z0-9]/g,""),r=l().join(process.cwd(),"public","mockup-templates",e),o="";if(n().existsSync(r)){let e=n().readdirSync(r).filter(e=>/\.(jpg|png|jpeg|webp)$/i.test(e));e.length>0&&(o=l().join(r,e[0]))}if(!o){let e="canvas_mockup.png";t.includes("bear")&&(e="bear_base.png"),t.includes("tumbler")&&(e="tumbler_base.png"),t.includes("mug")&&(e="mug_base.png"),o=l().join(process.cwd(),"public","assets","mockups",e)}if(n().existsSync(o)){c=n().readFileSync(o);let e=l().extname(o).toLowerCase();".png"===e&&(p="image/png")}}if(!c)return console.error(`Mockup template not found for ${t}`),null;let u=new s.$D(process.env.GOOGLE_AI_API_KEY).getGenerativeModel({model:g}),d=c.toString("base64"),m=a.toString("base64"),f=`Task: Professional Product Mockup Generation.
        Input 1: Designed Artwork (Portrait).
        Input 2: Product Mockup Template (Blank Product).
        
        Action: Realistically apply the Artwork from Input 1 onto the blank product surface in Input 2.
        
        Guidelines:
        1. Perspective & Wrapping: The artwork MUST follow the curvature and perspective of the product.
           - Canvas: Wrap naturally around the visible edges.
           - Apparel/Fabric: Follow the folds, wrinkles, and displacement of the fabric.
           - Cylinders (Mugs/Tumblers): Curve perfectly around the surface.
        2. Lighting & Shadows: Multiply the shadows and highlights from the Template onto the Artwork. The artwork should not look "floating" or "flat".
        3. Texture: Preserve the grain/texture of the product surface (e.g., canvas weave, cotton fabric).
        4. Integrity: Do NOT change the background or surrounding props of Input 2. Do NOT add new objects. Do NOT distort the subject of the Artwork.
        
        Output: A photorealistic final composite image.`,h=await u.generateContent([f,{inlineData:{data:m,mimeType:"image/png"}},{inlineData:{data:d,mimeType:p}}]),y=h.response.candidates?.[0]?.content?.parts,w=y?.find(e=>e.inlineData);if(w&&w.inlineData?.data?i=Buffer.from(w.inlineData.data,"base64"):(console.error("Nano Banana returned no image part for mockup."),i=null),i&&r){let e=l().dirname(r);n().existsSync(e)||n().mkdirSync(e,{recursive:!0}),n().writeFileSync(r,i),console.log(`[Mockup] Saved to ${r}`)}return i}catch(e){return console.error("Nano Mockup Generation failed:",e),null}}async function w(e,t,r="royalty",a="",i="",s=!1){let u;console.log(`Starting Smart Generation for order ${e} [Product: ${r}]`);let d=(0,o.i)(),g=l().join(process.cwd(),"public",t);try{if(n().existsSync(g))u=n().readFileSync(g);else if(n().existsSync(t))u=n().readFileSync(t);else{let e=await fetch(t);if(!e.ok)throw Error(`Failed to fetch ${t}`);u=Buffer.from(await e.arrayBuffer())}}catch(e){throw console.error("Failed to resolve pet photo:",e),e}let m=null,w=[];try{let{data:e}=await d.from("mockup_templates").select("*").eq("is_active",!0);if(e&&e.length>0){let t=r.toLowerCase().split(/[\s,-]+/),o=e.map(e=>{let r=0;return e.keywords&&e.keywords.forEach(e=>{t.some(t=>t.includes(e.toLowerCase())||e.toLowerCase().includes(t))&&(r+=1)}),{...e,score:r}});o.sort((e,t)=>t.score-e.score),o[0].score>0?(m=o[0],w=o.slice(1,3)):(m=e[0],w=e.slice(1,3)),console.log(`[Smart Gen] Matched Primary: ${m.name}, Upsells: ${w.length}`)}}catch(e){console.error("Error fetching templates:",e)}let b=f(r,5),$=function(e,t){let r=["royalty","spaday","minimalist","valentines"].filter(t=>!e.toLowerCase().includes(t));if(0===r.length)return[];let o=Math.floor(Math.random()*r.length),a=r[o];return console.log(`[Nano] Selected Bonus Theme: ${a}`),f(a,5).map(e=>({path:e,theme:a}))}(r,0),v=[],k=async(t,r,o=!1)=>{let a=`generated/${e}/${r}`;return(await (0,p.uploadFile)(a,t),o)?a:(0,p.getPublicUrl)(a)},_=null;for(let t=0;t<b.length;t++){console.log(`[Nano] Generating Primary Portrait ${t+1}/${b.length}...`);let r=b[t],o="Image 1 is the Reference Pet. Image 2 is the Scene Template. action: Replace the subject in Image 2 with the dog from Image 1.";a&&(o+=` The dog is a ${a}.`),o+=" Recreate the scene from Image 2 exactly, but using the dog from Image 1. Identity Lock: Mandatory.",i&&(o+=` Verify features: ${i}.`);let n=await h(r,u,o);if(n){_||(_=n);let r=`portrait_primary_${t}.png`,o=await k(n,r);v.push({order_id:e,url:o,storage_path:`generated/${e}/${r}`,type:"primary",display_order:t,theme_name:"Portrait Option",is_bonus:!1,status:s?"approved":"pending"})}}for(let t=0;t<$.length;t++){console.log(`[Nano] Generating Bonus Portrait ${t+1}/${$.length} (${$[t].theme})...`);let r=$[t].path,o="Image 1 is the Reference Pet. Image 2 is the Scene Template. action: Replace the subject in Image 2 with the dog from Image 1.";a&&(o+=` The dog is a ${a}.`),o+=" Recreate the scene from Image 2 exactly, but using the dog from Image 1. Identity Lock: Mandatory.";let n=await h(r,u,o);if(n){let r=`portrait_bonus_${t}.png`,o=await k(n,r);v.push({order_id:e,url:o,storage_path:`generated/${e}/${r}`,type:"primary",display_order:10+t,theme_name:`Bonus: ${$[t].theme}`,is_bonus:!0,status:s?"approved":"pending"})}}if(_&&r.toLowerCase().includes("canvas")){console.log("[Nano] Order includes Canvas. Generating Canvas Mockup...");let t=await y(_,"canvas-11x14");if(t){let r=`mockup_canvas_${Date.now()}.png`,o=await k(t,r);v.push({order_id:e,url:o,storage_path:`generated/${e}/${r}`,type:"upsell",display_order:100,theme_name:"Canvas Mockup",is_bonus:!1,status:s?"approved":"pending"})}}if(v.length>0){let{error:t}=await d.from("images").insert(v);if(t)throw console.error("Failed to insert images:",t),t;if(s){await d.from("orders").update({status:"fulfilled"}).eq("id",e);let{data:t}=await d.from("orders").select("customer_email, customer_name").eq("id",e).single();t&&await (0,c.l)(t.customer_email,t.customer_name,e,"ready")}console.log(`Saved ${v.length} images.`)}else console.error("No images generated.")}async function b(e,t,r,a=""){let n=[];if(a.toLowerCase().includes("canvas")&&n.push("canvas-11x14"),a.toLowerCase().includes("mug")&&n.push("mug"),a.toLowerCase().includes("tumbler")&&n.push("tumbler"),0===n.length)return console.log(`[Auto-Mockup] No physical products detected in type '${a}'. Skipping mockups.`),0;let i=[],l=(0,o.i)();for(let o of(console.log(`[Auto-Mockup] Starting batch for ${r} [${n.join(", ")}]`),n)){let a=`mockup_${o}_${r}_${Date.now()}.png`,n=`generated/${t}/mockups/${a}`;try{let a=await y(e,o);if(a){await (0,p.uploadFile)(n,a);let e=(0,p.getPublicUrl)(n);i.push({order_id:t,url:e,storage_path:n,type:"upsell",is_bonus:!1,status:"approved",template_id:r,theme_name:o.charAt(0).toUpperCase()+o.slice(1),display_order:100})}}catch(e){console.error(`Failed to generate ${o}:`,e)}}if(i.length>0){let{error:e}=await l.from("images").insert(i);if(e)throw console.error("Failed to insert mockups:",e),e;console.log(`[Auto-Mockup] Created ${i.length} variants`)}return i.length}},20471:(e,t,r)=>{r.d(t,{l:()=>a});var o=r(2723);async function a(e,t,r,a="ready",n){if(!process.env.RESEND_API_KEY)return console.warn("⚠️ RESEND_API_KEY missing. Skipping email send."),!1;let i=new o.R(process.env.RESEND_API_KEY),l=process.env.NEXT_PUBLIC_BASE_URL||"http://localhost:3000",s=`${l}/customer/gallery/${r}`;console.log(`[Email Service] Sending '${a}' notification to ${e}...`);let c="Your Pet Portraits are Ready! \uD83D\uDC3E",p="";"ordered"===a?(c="We’ve started your Pet Portrait! \uD83C\uDFA8",p=`
            <h1 style="color: #d97706;">We're on it!</h1>
            <p>Hi ${t},</p>
            <p>Thanks for your order! We've received your photos and our AI artists are hard at work creating your custom portraits.</p>
            <p>This usually takes 10-20 minutes. We'll send you another email as soon as they are ready for review.</p>
            <p style="margin-top: 20px;">Sit tight!</p>
        `):p=`
          <h1 style="color: #d97706;">Your Portraits are Here!</h1>
          <p>Hi ${t},</p>
          <p>We've finished working on your pet's portraits and they look amazing!</p>
          ${n?`<img src="${l}${n}" alt="Preview" style="width: 100%; max-width: 300px; border-radius: 8px; margin: 20px 0;" />`:""}
          <p>Click the button below to view your gallery, unlock your favorites, and share with friends.</p>
          <a href="${s}" style="display: inline-block; background-color: #d97706; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; font-weight: bold; margin-top: 10px;">View My Gallery</a>
          <p style="margin-top: 30px; font-size: 12px; color: #888;">
            If the button doesn't work, copy this link:<br>
            <a href="${s}">${s}</a>
          </p>
        `;try{let{data:t,error:r}=await i.emails.send({from:"Pet Portraits <onboarding@resend.dev>",to:[e],subject:c,html:`
        <div style="font-family: sans-serif; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
          ${p}
        </div>
      `});if(r)return console.error("[Email Service] Error:",r),!1;return console.log("[Email Service] Email sent successfully:",t?.id),!0}catch(e){return console.error("[Email Service] Exception:",e),!1}}},65655:(e,t,r)=>{r.d(t,{i:()=>a});var o=r(69498);function a(){let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return(0,o.eI)("https://opxgicxdrbpgpsxonogk.supabase.co",e,{auth:{autoRefreshToken:!1,persistSession:!1},global:{fetch:(e,t)=>fetch(e,{...t,cache:"no-store"})}})}},2390:(e,t,r)=>{r.d(t,{getPublicUrl:()=>i,uploadFile:()=>n});var o=r(65655);let a="primary-images";async function n(e,t,r="image/png"){let n=(0,o.i)(),{data:i,error:l}=await n.storage.from(a).upload(e,t,{contentType:r,upsert:!0});if(l)throw console.error(`[Storage] Upload failed for ${e}:`,l),l;return i}function i(e){let{data:t}=(0,o.i)().storage.from(a).getPublicUrl(e);return t.publicUrl}}};